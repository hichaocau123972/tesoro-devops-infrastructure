name: Deploy Ephemeral Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - develop
      - main
  pull_request:
    types: [closed]

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  deploy-preview:
    name: Deploy PR Preview Environment
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    environment:
      name: pr-${{ github.event.pull_request.number }}
      url: https://tesoro-pr-${{ github.event.pull_request.number }}.azurewebsites.net
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Ephemeral Resource Group
        id: rg
        run: |
          RG_NAME="tesoro-pr-${{ github.event.pull_request.number }}-rg"
          echo "rg-name=$RG_NAME" >> $GITHUB_OUTPUT

          az group create \
            --name $RG_NAME \
            --location eastus \
            --tags environment=ephemeral pr-number=${{ github.event.pull_request.number }} created-by=github-actions auto-delete=true

      - name: Deploy Lightweight Infrastructure
        id: deploy
        run: |
          # Deploy minimal infrastructure for PR testing
          az deployment group create \
            --name "pr-${{ github.event.pull_request.number }}-$(date +%Y%m%d-%H%M%S)" \
            --resource-group ${{ steps.rg.outputs.rg-name }} \
            --template-file infrastructure/bicep/ephemeral/main.bicep \
            --parameters prNumber=${{ github.event.pull_request.number }} \
            --parameters location=eastus \
            --output json > deployment-output.json

          APP_URL=$(jq -r '.properties.outputs.appUrl.value' deployment-output.json)
          echo "app-url=$APP_URL" >> $GITHUB_OUTPUT

      - name: Deploy Application Code
        run: |
          # Deploy the application to the ephemeral environment
          # This would typically involve building and deploying your app
          echo "Deploying application code to preview environment..."

      - name: Run Integration Tests
        run: |
          echo "Running integration tests on ${{ steps.deploy.outputs.app-url }}"
          # Add integration test commands here

      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸš€ Preview Environment Deployed

            Your preview environment is ready!

            - **URL**: ${{ steps.deploy.outputs.app-url }}
            - **Environment**: pr-${{ github.event.pull_request.number }}
            - **Resource Group**: ${{ steps.rg.outputs.rg-name }}

            ### What's included:
            - âœ… App Service (Basic tier)
            - âœ… SQL Database (lightweight)
            - âœ… Redis Cache (Basic)
            - âœ… Storage Account

            ### Actions:
            - Preview your changes at the URL above
            - Run manual tests
            - Environment will be automatically deleted when PR is closed

            *This environment will auto-delete in 7 days if PR remains open*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Set Auto-Delete Tag
        run: |
          # Set deletion timestamp (7 days from now)
          DELETE_DATE=$(date -u -d "+7 days" +%Y-%m-%d)
          az group update \
            --name ${{ steps.rg.outputs.rg-name }} \
            --set tags.auto-delete-date=$DELETE_DATE

  cleanup-preview:
    name: Cleanup PR Preview Environment
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Delete Resource Group
        run: |
          RG_NAME="tesoro-pr-${{ github.event.pull_request.number }}-rg"

          if az group exists --name $RG_NAME; then
            echo "Deleting resource group $RG_NAME..."
            az group delete --name $RG_NAME --yes --no-wait
            echo "âœ… Resource group deletion initiated"
          else
            echo "Resource group $RG_NAME does not exist"
          fi

      - name: Comment PR with Cleanup Status
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸ§¹ Preview Environment Cleanup

            Your preview environment has been deleted.

            - **Resource Group**: tesoro-pr-${{ github.event.pull_request.number }}-rg
            - **Status**: Deletion in progress

            All resources will be completely removed within 5-10 minutes.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  cleanup-stale:
    name: Cleanup Stale Ephemeral Environments
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Find and Delete Stale Resource Groups
        run: |
          # Find all ephemeral resource groups with auto-delete tag
          CURRENT_DATE=$(date -u +%Y-%m-%d)

          az group list --query "[?tags.environment=='ephemeral' && tags.'auto-delete'=='true']" -o json | \
          jq -r '.[] | select(.tags."auto-delete-date" <= "'$CURRENT_DATE'") | .name' | \
          while read RG_NAME; do
            echo "Deleting stale resource group: $RG_NAME"
            az group delete --name $RG_NAME --yes --no-wait
          done
